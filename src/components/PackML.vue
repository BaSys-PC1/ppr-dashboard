<template>
    <div>
        <div class="mxgraph" style="position:relative;overflow:auto;">&lt;mxGraphModel dx="759" dy="759" grid="1"
            gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1"
            pageWidth="827" pageHeight="1169" background="#ffffff" math="0" shadow="0"&gt;&lt;root&gt;&lt;mxCell
            id="0"/&gt;&lt;mxCell id="1" parent="0"/&gt;&lt;mxCell id="23" value="Hold"
            style="edgeStyle=orthogonalEdgeStyle;rounded=0;html=1;exitX=0.75;exitY=0;entryX=0.5;entryY=1;jettySize=auto;orthogonalLoop=1;"
            parent="1" source="2" target="8" edge="1"&gt;&lt;mxGeometry relative="1" as="geometry"/&gt;&lt;/mxCell&gt;&lt;mxCell
            id="26" value="SC"
            style="edgeStyle=orthogonalEdgeStyle;rounded=0;html=1;exitX=1;exitY=0.5;entryX=0;entryY=0.5;jettySize=auto;orthogonalLoop=1;"
            parent="1" source="2" target="11" edge="1"&gt;&lt;mxGeometry relative="1" as="geometry"/&gt;&lt;/mxCell&gt;&lt;mxCell
            id="29" value="Suspend"
            style="edgeStyle=orthogonalEdgeStyle;rounded=0;html=1;exitX=0.75;exitY=1;entryX=0.5;entryY=0;jettySize=auto;orthogonalLoop=1;"
            parent="1" source="2" target="12" edge="1"&gt;&lt;mxGeometry relative="1" as="geometry"/&gt;&lt;/mxCell&gt;&lt;mxCell
            id="2" value="EXECUTE" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;"
            parent="1" vertex="1"&gt;&lt;mxGeometry x="380" y="150" width="120" height="60" as="geometry"/&gt;&lt;/mxCell&gt;&lt;mxCell
            id="21" value="Unhold"
            style="edgeStyle=orthogonalEdgeStyle;rounded=0;html=1;entryX=1;entryY=0.5;jettySize=auto;orthogonalLoop=1;"
            parent="1" source="3" target="5" edge="1"&gt;&lt;mxGeometry relative="1" as="geometry"/&gt;&lt;/mxCell&gt;&lt;mxCell
            id="3" value="HELD" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;"
            parent="1" vertex="1"&gt;&lt;mxGeometry x="380" y="40" width="120" height="60" as="geometry"/&gt;&lt;/mxCell&gt;&lt;mxCell
            id="31" value="Unsuspend"
            style="edgeStyle=orthogonalEdgeStyle;rounded=0;html=1;exitX=0;exitY=0.5;entryX=1;entryY=0.5;jettySize=auto;orthogonalLoop=1;"
            parent="1" source="4" target="7" edge="1"&gt;&lt;mxGeometry relative="1" as="geometry"/&gt;&lt;/mxCell&gt;&lt;mxCell
            id="4" value="SUSPENDED" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;"
            parent="1" vertex="1"&gt;&lt;mxGeometry x="380" y="270" width="120" height="60" as="geometry"/&gt;&lt;/mxCell&gt;&lt;mxCell
            id="24" value="SC"
            style="edgeStyle=orthogonalEdgeStyle;rounded=0;html=1;exitX=0.5;exitY=1;entryX=0.25;entryY=0;jettySize=auto;orthogonalLoop=1;"
            parent="1" source="5" target="2" edge="1"&gt;&lt;mxGeometry relative="1" as="geometry"/&gt;&lt;/mxCell&gt;&lt;mxCell
            id="5" value="UNHOLDING" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;"
            parent="1" vertex="1"&gt;&lt;mxGeometry x="180" y="40" width="120" height="60" as="geometry"/&gt;&lt;/mxCell&gt;&lt;mxCell
            id="25" value="SC"
            style="edgeStyle=orthogonalEdgeStyle;rounded=0;html=1;exitX=1;exitY=0.5;entryX=0;entryY=0.5;jettySize=auto;orthogonalLoop=1;"
            parent="1" source="6" target="2" edge="1"&gt;&lt;mxGeometry relative="1" as="geometry"/&gt;&lt;/mxCell&gt;&lt;mxCell
            id="6" value="STARTING" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;"
            parent="1" vertex="1"&gt;&lt;mxGeometry x="180" y="150" width="120" height="60" as="geometry"/&gt;&lt;/mxCell&gt;&lt;mxCell
            id="40" value="SC"
            style="edgeStyle=orthogonalEdgeStyle;rounded=0;html=1;exitX=0.5;exitY=0;entryX=0.183;entryY=1.033;entryPerimeter=0;jettySize=auto;orthogonalLoop=1;"
            parent="1" source="7" target="2" edge="1"&gt;&lt;mxGeometry relative="1" as="geometry"/&gt;&lt;/mxCell&gt;&lt;mxCell
            id="7" value="UNSUSPENDING"
            style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1"&gt;&lt;mxGeometry
            x="180" y="270" width="120" height="60" as="geometry"/&gt;&lt;/mxCell&gt;&lt;mxCell id="22" value="SC"
            style="edgeStyle=orthogonalEdgeStyle;rounded=0;html=1;exitX=0;exitY=0.5;entryX=1;entryY=0.5;jettySize=auto;orthogonalLoop=1;"
            parent="1" source="8" target="3" edge="1"&gt;&lt;mxGeometry relative="1" as="geometry"/&gt;&lt;/mxCell&gt;&lt;mxCell
            id="8" value="HOLDING" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;"
            parent="1" vertex="1"&gt;&lt;mxGeometry x="570" y="40" width="120" height="60" as="geometry"/&gt;&lt;/mxCell&gt;&lt;mxCell
            id="33" value="Start"
            style="edgeStyle=orthogonalEdgeStyle;rounded=0;html=1;exitX=1;exitY=0.5;entryX=0;entryY=0.5;jettySize=auto;orthogonalLoop=1;"
            parent="1" source="9" target="6" edge="1"&gt;&lt;mxGeometry relative="1" as="geometry"/&gt;&lt;/mxCell&gt;&lt;mxCell
            id="9" value="IDLE" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;"
            parent="1" vertex="1"&gt;&lt;mxGeometry x="20" y="150" width="120" height="60" as="geometry"/&gt;&lt;/mxCell&gt;&lt;mxCell
            id="32" value="SC"
            style="edgeStyle=orthogonalEdgeStyle;rounded=0;html=1;exitX=0.5;exitY=0;entryX=0.5;entryY=1;jettySize=auto;orthogonalLoop=1;"
            parent="1" source="10" target="9" edge="1"&gt;&lt;mxGeometry relative="1" as="geometry"/&gt;&lt;/mxCell&gt;&lt;mxCell
            id="10" value="RESETTING"
            style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1"&gt;&lt;mxGeometry
            x="20" y="270" width="120" height="60" as="geometry"/&gt;&lt;/mxCell&gt;&lt;mxCell id="27" value="SC"
            style="edgeStyle=orthogonalEdgeStyle;rounded=0;html=1;exitX=1;exitY=0.5;jettySize=auto;orthogonalLoop=1;"
            parent="1" source="11" target="15" edge="1"&gt;&lt;mxGeometry relative="1" as="geometry"/&gt;&lt;/mxCell&gt;&lt;mxCell
            id="11" value="COMPLETING"
            style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1"&gt;&lt;mxGeometry
            x="570" y="150" width="120" height="60" as="geometry"/&gt;&lt;/mxCell&gt;&lt;mxCell id="30" value="SC"
            style="edgeStyle=orthogonalEdgeStyle;rounded=0;html=1;exitX=0;exitY=0.5;entryX=1;entryY=0.5;jettySize=auto;orthogonalLoop=1;"
            parent="1" source="12" target="4" edge="1"&gt;&lt;mxGeometry relative="1" as="geometry"/&gt;&lt;/mxCell&gt;&lt;mxCell
            id="12" value="SUSPENDING"
            style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1"&gt;&lt;mxGeometry
            x="570" y="270" width="120" height="60" as="geometry"/&gt;&lt;/mxCell&gt;&lt;mxCell id="35"
            value="Reset"
            style="edgeStyle=orthogonalEdgeStyle;rounded=0;html=1;exitX=0.25;exitY=0;entryX=0.25;entryY=1;jettySize=auto;orthogonalLoop=1;"
            parent="1" source="13" target="10" edge="1"&gt;&lt;mxGeometry relative="1" as="geometry"/&gt;&lt;/mxCell&gt;&lt;mxCell
            id="13" value="STOPPED" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;"
            parent="1" vertex="1"&gt;&lt;mxGeometry x="20" y="417" width="120" height="60" as="geometry"/&gt;&lt;/mxCell&gt;&lt;mxCell
            id="36" value="SC"
            style="edgeStyle=orthogonalEdgeStyle;rounded=0;html=1;exitX=0;exitY=0.5;jettySize=auto;orthogonalLoop=1;"
            parent="1" source="14" target="13" edge="1"&gt;&lt;mxGeometry relative="1" as="geometry"/&gt;&lt;/mxCell&gt;&lt;mxCell
            id="14" value="STOPPING" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;"
            parent="1" vertex="1"&gt;&lt;mxGeometry x="200" y="417" width="120" height="60" as="geometry"/&gt;&lt;/mxCell&gt;&lt;mxCell
            id="28" value="Reset"
            style="edgeStyle=orthogonalEdgeStyle;rounded=0;html=1;exitX=0.5;exitY=1;entryX=0.5;entryY=1;jettySize=auto;orthogonalLoop=1;"
            parent="1" source="15" target="10" edge="1"&gt;&lt;mxGeometry relative="1" as="geometry"&gt;&lt;Array
            as="points"&gt;&lt;mxPoint x="790" y="350"/&gt;&lt;mxPoint x="80" y="350"/&gt;&lt;/Array&gt;&lt;/mxGeometry&gt;&lt;/mxCell&gt;&lt;mxCell
            id="15" value="COMPLETE" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;"
            parent="1" vertex="1"&gt;&lt;mxGeometry x="730" y="150" width="120" height="60" as="geometry"/&gt;&lt;/mxCell&gt;&lt;mxCell
            id="37" value="SC"
            style="edgeStyle=orthogonalEdgeStyle;rounded=0;html=1;exitX=0;exitY=0.5;entryX=0.75;entryY=1;jettySize=auto;orthogonalLoop=1;"
            parent="1" source="16" target="13" edge="1"&gt;&lt;mxGeometry relative="1" as="geometry"&gt;&lt;Array
            as="points"&gt;&lt;mxPoint x="380" y="427"/&gt;&lt;mxPoint x="350" y="427"/&gt;&lt;mxPoint x="350"
            y="500"/&gt;&lt;mxPoint x="110" y="500"/&gt;&lt;/Array&gt;&lt;/mxGeometry&gt;&lt;/mxCell&gt;&lt;mxCell
            id="16" value="CLEARING" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;"
            parent="1" vertex="1"&gt;&lt;mxGeometry x="380" y="417" width="120" height="60" as="geometry"/&gt;&lt;/mxCell&gt;&lt;mxCell
            id="38" value="Clear"
            style="edgeStyle=orthogonalEdgeStyle;rounded=0;html=1;exitX=0;exitY=0.5;entryX=1;entryY=0.5;jettySize=auto;orthogonalLoop=1;"
            parent="1" source="17" target="16" edge="1"&gt;&lt;mxGeometry relative="1" as="geometry"/&gt;&lt;/mxCell&gt;&lt;mxCell
            id="17" value="ABORTED" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;"
            parent="1" vertex="1"&gt;&lt;mxGeometry x="570" y="417" width="120" height="60" as="geometry"/&gt;&lt;/mxCell&gt;&lt;mxCell
            id="39" value="SC"
            style="edgeStyle=orthogonalEdgeStyle;rounded=0;html=1;exitX=0;exitY=0.5;entryX=1;entryY=0.5;jettySize=auto;orthogonalLoop=1;"
            parent="1" target="17" edge="1"&gt;&lt;mxGeometry relative="1" as="geometry"&gt;&lt;mxPoint x="730"
            y="447" as="sourcePoint"/&gt;&lt;/mxGeometry&gt;&lt;/mxCell&gt;&lt;mxCell id="18" value="ABORTING"
            style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;" parent="1" vertex="1"&gt;&lt;mxGeometry
            x="730" y="420" width="120" height="60" as="geometry"/&gt;&lt;/mxCell&gt;&lt;mxCell id="41" value="SC =
            State Change"
            style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;"
            vertex="1" parent="1"&gt;&lt;mxGeometry x="20" y="60" width="130" height="20" as="geometry"/&gt;&lt;/mxCell&gt;&lt;mxCell
            id="47" value="Abort"
            style="edgeStyle=orthogonalEdgeStyle;rounded=0;html=1;exitX=0.919;exitY=1.012;jettySize=auto;orthogonalLoop=1;exitPerimeter=0;"
            edge="1" parent="1" source="43" target="18"&gt;&lt;mxGeometry relative="1" as="geometry"/&gt;&lt;/mxCell&gt;&lt;mxCell
            id="48" value="Stop"
            style="edgeStyle=orthogonalEdgeStyle;rounded=0;html=1;entryX=0.5;entryY=0;jettySize=auto;orthogonalLoop=1;exitX=0.294;exitY=1;exitPerimeter=0;"
            edge="1" parent="1" source="43" target="14"&gt;&lt;mxGeometry relative="1" as="geometry"&gt;&lt;mxPoint
            x="260" y="380" as="sourcePoint"/&gt;&lt;/mxGeometry&gt;&lt;/mxCell&gt;&lt;mxCell id="43" value=""
            style="rounded=1;arcSize=10;dashed=1;strokeColor=#000000;fillColor=none;gradientColor=none;dashPattern=8
            3 1 3;strokeWidth=2;" vertex="1" parent="1"&gt;&lt;mxGeometry x="10" y="30" width="850" height="338"
            as="geometry"/&gt;&lt;/mxCell&gt;&lt;/root&gt;&lt;/mxGraphModel&gt;
        </div>
        <div class="mxgraph" style="position:relative;overflow:auto;"></div>
        <b-modal id="modal-pack" title="BootstrapVue" size="lg">
            <template v-slot:modal-header>
                <h5 class="modal-title">PackML Automaton</h5>
                <button type="button" id="stop-btn" class="btn btn-danger ml-3">Stop</button>
                <button type="button" id="reset-btn" class="btn btn-warning ml-3">Reset</button>

                <div class="btn-group btn-group-toggle ml-3 mode-group" data-toggle="buttons">
                    <label class="btn btn-info active" data-mode="PRODUCTION" id="l_PRODUCTION">
                        <input type="radio" name="options" autocomplete="off" checked> PRODUCTION
                    </label>
                    <label class="btn btn-info" data-mode="CHANGE_OVER" id="l_CHANGE_OVER">
                        <input type="radio" name="options" autocomplete="off"> CHANGEOVER
                    </label>
                    <label class="btn btn-info" data-mode="SIMULATION" id="l_SIMULATION">
                        <input type="radio" name="options" autocomplete="off"> SIMULATION
                    </label>
                </div>

            </template>

            <div class="modal-body">
                PackML
            </div>
            <template v-slot:modal-footer={cancel}>
                <b-button variant="secondary" @click="cancel">
                    {{$t("translation.modal_close")}}
                </b-button>
            </template>

        </b-modal>
    </div>
</template>

<script>
    import * as mxgraph from 'mxgraph';

    const {
        mxClient, mxGraph, mxRubberband, mxUtils, mxEvent, mxCodec, mxConstants
    } = mxgraph();

    export default {
        name: "PackML",
        data() {
            return {
                //graph: ""
            }
        },
        methods: {
            initGraph: function () {

                let graph;

                if (mxClient.isBrowserSupported()) {
                    let divs = document.getElementsByClassName('mxgraph');

                    for (let i = 0; i < divs.length; i++) {
                        (container => {
                            let xml = mxUtils.getTextContent(container);
                            let xmlDocument = mxUtils.parseXml(xml);

                            if (xmlDocument.documentElement != null && xmlDocument.documentElement.nodeName == 'mxGraphModel') {
                                let codec = new mxCodec(xmlDocument);
                                let node = xmlDocument.documentElement;

                                container.innerHTML = '';

                                graph = new mxGraph(container);
                                graph.setTooltips(true);
                                graph.setEnabled(false);
                                //graph.htmlLabels = true;

                                // Changes the default style for edges "in-place"
                                let style = graph.getStylesheet().getDefaultEdgeStyle();
                                //style[mxConstants.STYLE_EDGE] = mxEdgeStyle.ElbowConnector;

                                style[mxConstants.STYLE_VERTICAL_ALIGN] = mxConstants.ALIGN_TOP;
                                //style[mxConstants.STYLE_LABEL_BACKGROUNDCOLOR] = "#fff";

                                codec.decode(node, graph.getModel());

                                //graph.resizeContainer = true;

                            }
                        })(divs[i]);
                    }

                    //zoom out to fit the modal size (leads to display errors on tablet)
                    graph.zoomFactor = 1.15;
                    graph.zoomOut();

                }
                /*
                if (mxClient.isBrowserSupported()) {

                    let divs = document.getElementsByClassName('mxgraph');
                    console.log(divs);

                    let xml = mxUtils.getTextContent(this.$refs.mx);

                    let xmlDocument = mxUtils.parseXml(xml);

                    if (xmlDocument.documentElement != null && xmlDocument.documentElement.nodeName == 'mxGraphModel') {

                        let codec = new mxCodec(xmlDocument);
                        let node = xmlDocument.documentElement;

                        this.$refs.mx.innerHTML = '';

                        this.graph = new mxGraph(this.$refs.mx);
                        this.graph.setTooltips(true);
                        this.graph.setEnabled(false);

                        console.log(this.graph);

                        // Changes the default style for edges "in-place"
                        let style = this.graph.getStylesheet().getDefaultEdgeStyle();
                        style[mxConstants.STYLE_VERTICAL_ALIGN] = mxConstants.ALIGN_TOP;

                        codec.decode(node, this.graph.getModel());

                    }
                }

                //zoom out to fit the modal size (leads to display errors on tablet)
                this.graph.zoomFactor = 1.15;
                this.graph.zoomOut();
*/
            },
            markCurrentState: function (state) {

                let vertices = this.graph.getChildCells(graph.getDefaultParent(), true, false);

                for (let i = 0; i < vertices.length; i++) {
                    if (vertices[i].value === state) {
                        currentCell = vertices[i];
                    }
                }

                //change style of active state
                if (currentCell !== null) {

                    let oldColor = this.graph.getCellStyle(currentCell)[mxConstants.STYLE_STROKECOLOR];

                    this.graph.setCellStyles(mxConstants.STYLE_STROKECOLOR, "#F00", [currentCell]);

                    return oldColor;
                } else {
                    console.error("Current state '" + state + "' not found.");
                    return null;
                }

            }

        },
        mounted() {
            this.initGraph();
        },
    };

</script>

<style scoped>

</style>